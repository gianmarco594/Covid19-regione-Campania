<!DOCTYPE html>

<html>
<head>
    <meta charset="UTF-8" />
    <title>Covid regione Campania</title>
    <meta name="author" content="Gianmarco Beato, Angela Vecchione, Alfonso Golino" />
    <meta name="description" content="progetto basi di dati 12 - Covid19 Regione Campania" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="./assets/styles/jquery-jvectormap-2.0.5.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="./assets/styles/main_style.css" tyoe="text/css" />
    <link rel="shortcut icon" href="./assets/images/favicon.png" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="./javascript_client/jquery-jvectormap-2.0.5.min.js"></script>
    <script src="./javascript_client/jquery-jvectormap-it-merc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <script defer src="./javascript_client/main.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>

<body>
    <noscript>Questa pagina richiede javascript</noscript>
    
    <div class="header">
        <div class="header_flex">
            <img src="./assets/images/coronaviruslogo.png" alt="coronaviruslogo" />
            <h3>CORONAVIRUS REGIONE CAMPANIA</h3>
        </div>
    </div>

    <div class="container">

        <div class="regione">
            <div id="map">
            </div>

            <div style="padding: 30px 30px 5px 30px">Ultimo aggiornamento: <span id="aggiornamento"></span> - ore 18:00. Dati del dipartimento della Protezione Civile</div>
        </div>

        <br>
        
        <!--<div class="row">-->

            <div class="square">
                <div class="data">
                    <span>Casi totali</span>
                    <div><canvas id="casi-totali"></canvas></div>
                </div>
            </div>

            <div class="square">
                <div class="data">
                    <span>Nuovi positivi</span>
                    <canvas id="nuovi-positivi"></canvas>
                </div>
            </div>

            <div class="square">
                <div class="data">
                    <span>Attualmente Positivi</span>
                    <canvas id="attualmente-positivi"></canvas>
                </div>
            </div>

        <!--</div>-->

        <!--<div class="row">-->

            <div class="square">
                <div class="data">
                    <span>Totale tamponi</span>
                    <canvas id="tamponi"></canvas>
                </div>
            </div>

            <div class="square">
                <div class="data">
                    <span>Totale guariti</span>
                    <canvas id="guariti"></canvas>
                </div>
            </div>

            <div class="square">
                <div class="data">
                    <span>Totale deceduti</span>
                    <canvas id="deceduti"></canvas>
                </div>
            </div>

        <!--</div>-->

        <!--<div class="row">-->

            <div class="square">
                <div class="data">
                    <span>Totale isolati a domicilio</span>
                    <canvas id="isolati-domicilio"></canvas>
                </div>
            </div>

            <div class="square">
                <div class="data">
                    <span>Totale in terapia intensiva</span>
                    <canvas id="terapia-intensiva"></canvas>
                </div>
            </div>

            <div class="square">
                <div class="data">
                    <span>Totale ricoverati con sintomi</span>
                    <canvas id="ricoverati"></canvas>
                </div>
            </div>

        <!--</div>-->

    </div>
    <script>
         var mesi = [];
        function enumeraDate(start, end) {
                Date.prototype.addDays = function(days) {
                    var dat = new Date(this.valueOf())
                    dat.setDate(dat.getDate() + days);
                    return dat;
                }

                function getDate(startDate, stopDate) {
                    var dateArray = new Array();
                    var currentDate = startDate;
                    var stringData = "";
                   
                    mesi["Jan"] = "Gennaio";
                    mesi["Feb"] = "Febbraio";
                    mesi["Mar"] = "Marzo";
                    mesi["Apr"] = "Aprile";
                    mesi["May"] = "Maggio";
                    mesi["Jun"] = "Giugno";
                    mesi["Jul"] = "Luglio";
                    mesi["Aug"] = "Agosto";
                    mesi["Sep"] = "Settembre";
                    mesi["Oct"] = "Ottobre";
                    mesi["Nov"] = "Novembre";
                    mesi["Dec"] = "Dicembre";

                    var currentYear = String(new Date().getFullYear());
                    while (currentDate <= stopDate) {
                        stringData = String(currentDate).slice(4, 10);
                        stringData = stringData.slice(4, 6) + " " + mesi[stringData.slice(0, 3)] + " " + currentYear;
                        dateArray.push(stringData);
                        currentDate = currentDate.addDays(1);
                    }
                    return dateArray;
                }

                var dateArray = getDate(start, end);
                return dateArray;
        }

        var data = new Date();
        var dataDaStampare = new Date();
        var meseOdierno = [];
        meseOdierno["0"] = "Gennaio";
        meseOdierno["1"] = "Febbraio";
        meseOdierno["2"] = "Marzo";
        meseOdierno["3"] = "Aprile";
        meseOdierno["4"] = "Maggio";
        meseOdierno["5"] = "Giugno";
        meseOdierno["6"] = "Luglio";
        meseOdierno["7"] = "Agosto";
        meseOdierno["8"] = "Settembre";
        meseOdierno["9"] = "Ottobre";
        meseOdierno["10"] = "Novembre";
        meseOdierno["11"] = "Dicembre";


        if (data.getHours() < 17) {
            data.setDate(data.getDate() - 1);

            dataDaStampare.setDate(dataDaStampare.getDate() - 1);
            document.getElementById("aggiornamento").innerHTML = dataDaStampare.getDate() + " " + meseOdierno[String(new Date().getMonth())] + " " + new Date().getFullYear();
        } else {
            document.getElementById("aggiornamento").innerHTML = dataDaStampare.getDate() + " " + meseOdierno[String(new Date().getMonth())] + " " + new Date().getFullYear()
        }

        var date = enumeraDate(new Date("2020-02-24"), data);

        var socket = io.connect('http://localhost:8080');
        var casiTotali;
        var nuoviPositivi; 
        var attualmentePositivi; 
        var tamponi; 
        var guariti; 
        var deceduti; 
        var isolati;
        var terapia;
        var ricoverati;
        socket.on("message", function (data) {
            if (data == null) { 
                alert("no"); socket.close(); 
            } else { 
                casiTotali = data.casi_totali;
                nuoviPositivi = data.nuovi_positivi;
                attualmentePositivi = data.totale_positivi;
                tamponi = data.tamponi;
                guariti = data.dimessi_guariti;
                deceduti = data.deceduti;
                isolati = data.isolamento_domiciliare;
                terapia = data.terapia_intensiva;
                ricoverati = data.ricoverati;
                createGrafici("casi-totali", casiTotali, "Casi totali", "rgb(255, 99, 180)");
                createGrafici("nuovi-positivi", nuoviPositivi, "Nuovi positivi", "rgb(255, 0, 0)");
                createGrafici("attualmente-positivi", attualmentePositivi, "Attualmente positivi", "rgb(255, 102, 0)");
                createGrafici("tamponi", tamponi, "Tamponi", "rgb(0, 153, 255)");
                createGrafici("guariti", guariti, "Guariti", "rgb(0, 255, 0)");
                createGrafici("deceduti", deceduti, "Deceduti", "rgb(204, 0, 0)");
                createGrafici("isolati-domicilio", isolati, "Isolati a domicilio", "rgb(255, 204, 0)");
                createGrafici("terapia-intensiva", terapia, "In terapia intensiva", "rgb(204, 102, 255)");
                createGrafici("ricoverati", ricoverati, "Ricoverati con sintomi", "rgb(0, 153, 204)");
            }
        });

        function createGrafici(id, valori, descrizione, color) {
            var ctx = document.getElementById(id).getContext('2d');
            var chart = new Chart(ctx, {
                // The type of chart we want to create
                type: 'line',

                // The data for our dataset
                data: {
                    labels: date,
                    datasets: [{
                        label: descrizione,
                        backgroundColor: 'rgba(0, 0, 0, 0.0)',
                        borderColor: color,
                        data: valori
                    }]
                },

                // Configuration options go here
                options: {
                    legend: {
                        display: false
                    },

                    animation: {
                        duration: 2000
                    }
                }
            }); 
        }
    </script>

</body>
</html>